name: Real Integrations

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "30 3 * * 1"

permissions:
  contents: read

jobs:
  preflight:
    runs-on: ubuntu-latest
    timeout-minutes: 35
    outputs:
      run_any: ${{ steps.preflight.outputs.run_any }}
      run_external: ${{ steps.preflight.outputs.run_external }}
      run_llm: ${{ steps.preflight.outputs.run_llm }}
      status: ${{ steps.preflight.outputs.status }}
      reason: ${{ steps.preflight.outputs.reason }}
    env:
      REAL_EXTERNAL_URL: ${{ secrets.REAL_EXTERNAL_URL }}
      REAL_LLM_BASE_URL: ${{ secrets.REAL_LLM_BASE_URL }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Restore node_modules cache
        id: node_modules_cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-
      - name: Install dependencies
        if: steps.node_modules_cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          while true; do
            echo "[heartbeat][install] $(date -u +'%Y-%m-%dT%H:%M:%SZ') npm ci running..."
            sleep 20
          done &
          HEARTBEAT_PID=$!
          trap 'kill $HEARTBEAT_PID >/dev/null 2>&1 || true' EXIT
          npm ci

      - name: Live preflight
        id: preflight
        run: npm run test:live:preflight

      - name: Strict gate on required live triggers (no silent skip)
        if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
        run: |
          set -euo pipefail
          node <<'NODE'
          const fs = require("node:fs");
          const reportPath = ".runtime-cache/test_output/live-preflight/latest.json";
          const summaryPath = process.env.GITHUB_STEP_SUMMARY;

          function appendSummary(lines) {
            if (!summaryPath) return;
            fs.appendFileSync(summaryPath, `${lines.join("\n")}\n`, "utf-8");
          }

          let report = null;
          try {
            report = JSON.parse(fs.readFileSync(reportPath, "utf-8"));
          } catch (error) {
            appendSummary([
              "## Real Integrations (Strict Main Gate)",
              "",
              "- Status: failed",
              `- Reason: live preflight report missing or unreadable (\`${reportPath}\`)`,
            ]);
            console.error(`[real-integration] strict gate failed: unable to read ${reportPath}`);
            process.exit(1);
          }

          const status = String(report?.status ?? "unknown");
          const runAny = report?.runAny === true;
          const checks = Array.isArray(report?.checks) ? report.checks : [];
          const successfulLiveChecks = checks.filter((item) => String(item?.status ?? "") === "ok");
          const missingOrFailed = checks.filter((item) => {
            const checkStatus = String(item?.status ?? "");
            return checkStatus === "missing" || checkStatus === "failed";
          });

          const summaryLines = [
            "## Real Integrations (Strict Main Gate)",
            "",
            `- Branch: ${process.env.GITHUB_REF ?? "unknown"}`,
            `- Event: ${process.env.GITHUB_EVENT_NAME ?? "unknown"}`,
            `- Preflight status: ${status}`,
            `- run_any: ${runAny ? "true" : "false"}`,
            `- Successful live checks: ${successfulLiveChecks.length}`,
          ];

          if (missingOrFailed.length > 0) {
            summaryLines.push("- Missing/failed prerequisites:");
            for (const item of missingOrFailed) {
              const name = String(item?.name ?? "unknown");
              const message = String(item?.message ?? "no details");
              const source = String(item?.source ?? "unknown");
              summaryLines.push(`  - ${name}: ${message} (source: ${source})`);
            }
          } else {
            summaryLines.push("- Missing/failed prerequisites: none");
          }

          if (report?.reason) {
            summaryLines.push(`- Diagnostic: ${String(report.reason)}`);
          }
          appendSummary(summaryLines);

          if (!runAny) {
            console.error("[real-integration] strict gate failed: no runnable live checks for required trigger");
            process.exit(1);
          }
          if (successfulLiveChecks.length < 1) {
            console.error("[real-integration] strict gate failed: no successful live checks recorded");
            process.exit(1);
          }
          if (status !== "passed") {
            console.error(`[real-integration] strict gate failed: live preflight status=${status}`);
            process.exit(1);
          }
          NODE

      - name: Skip notice (optional workflow)
        if: steps.preflight.outputs.run_any != 'true' && github.ref != 'refs/heads/main'
        run: |
          echo "::notice::${{ steps.preflight.outputs.reason }}"
          {
            echo "## Real Integrations"
            echo ""
            echo "Status: skipped (optional)"
            echo ""
            echo "Reason: ${{ steps.preflight.outputs.reason }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload live preflight report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: live-preflight-report
          path: .runtime-cache/test_output/live-preflight/latest.json
          if-no-files-found: ignore

  external-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: preflight
    env:
      REAL_EXTERNAL_URL: ${{ secrets.REAL_EXTERNAL_URL }}
    steps:
      - name: External E2E skip notice
        if: needs.preflight.outputs.run_external != 'true'
        run: |
          echo "::notice::REAL_EXTERNAL_URL missing, external E2E not executed."

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        if: needs.preflight.outputs.run_external == 'true'
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        if: needs.preflight.outputs.run_external == 'true'
        with:
          node-version: "20"
          cache: "npm"
      - name: Restore node_modules cache
        id: node_modules_cache
        if: needs.preflight.outputs.run_external == 'true'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-
      - name: Install dependencies
        if: needs.preflight.outputs.run_external == 'true' && steps.node_modules_cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          while true; do
            echo "[heartbeat][install] $(date -u +'%Y-%m-%dT%H:%M:%SZ') npm ci running..."
            sleep 20
          done &
          HEARTBEAT_PID=$!
          trap 'kill $HEARTBEAT_PID >/dev/null 2>&1 || true' EXIT
          npm ci

      - name: Cache Playwright browsers
        if: needs.preflight.outputs.run_external == 'true'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-ms-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-ms-playwright-

      - name: Install Playwright browser
        if: needs.preflight.outputs.run_external == 'true'
        run: |
          set -euo pipefail
          while true; do
            echo "[heartbeat][external-install] $(date -u +'%Y-%m-%dT%H:%M:%SZ') playwright install running..."
            sleep 20
          done &
          HEARTBEAT_PID=$!
          trap 'kill $HEARTBEAT_PID >/dev/null 2>&1 || true' EXIT
          npm run test:e2e:install

      - name: Run external E2E
        if: needs.preflight.outputs.run_external == 'true'
        run: |
          set -euo pipefail
          while true; do
            echo "[heartbeat][external-e2e] $(date -u +'%Y-%m-%dT%H:%M:%SZ') external e2e running..."
            sleep 20
          done &
          HEARTBEAT_PID=$!
          trap 'kill $HEARTBEAT_PID >/dev/null 2>&1 || true' EXIT
          npm run test:e2e:external

  real-llm:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: preflight
    env:
      REAL_LLM_BASE_URL: ${{ secrets.REAL_LLM_BASE_URL }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    steps:
      - name: Real LLM skip notice
        if: needs.preflight.outputs.run_llm != 'true'
        run: |
          echo "::notice::REAL_LLM_BASE_URL/GEMINI_API_KEY missing, LLM smoke not executed."

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        if: needs.preflight.outputs.run_llm == 'true'
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        if: needs.preflight.outputs.run_llm == 'true'
        with:
          node-version: "20"
          cache: "npm"
      - name: Restore node_modules cache
        id: node_modules_cache
        if: needs.preflight.outputs.run_llm == 'true'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-
      - name: Install dependencies
        if: needs.preflight.outputs.run_llm == 'true' && steps.node_modules_cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          while true; do
            echo "[heartbeat][install] $(date -u +'%Y-%m-%dT%H:%M:%SZ') npm ci running..."
            sleep 20
          done &
          HEARTBEAT_PID=$!
          trap 'kill $HEARTBEAT_PID >/dev/null 2>&1 || true' EXIT
          npm ci

      - name: Run real LLM smoke
        if: needs.preflight.outputs.run_llm == 'true'
        run: |
          set -euo pipefail
          while true; do
            echo "[heartbeat][real-llm] $(date -u +'%Y-%m-%dT%H:%M:%SZ') real llm smoke running..."
            sleep 20
          done &
          HEARTBEAT_PID=$!
          trap 'kill $HEARTBEAT_PID >/dev/null 2>&1 || true' EXIT
          npm run test:real:llm

      - name: Upload real LLM report
        if: needs.preflight.outputs.run_llm == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: real-llm-report
          path: .runtime-cache/test_output/real-llm/latest.json
          if-no-files-found: ignore
