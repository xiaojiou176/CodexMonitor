name: Mutation Weekly

on:
  schedule:
    - cron: "0 9 * * 1"
  workflow_dispatch:

concurrency:
  group: mutation-weekly-${{ github.ref }}
  cancel-in-progress: false

permissions: {}

jobs:
  mutation-python:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Detect Python mutmut config
        id: detect_python
        run: |
          set -euo pipefail
          if [ -f ".mutmut-config" ] || \
             ( [ -f "pyproject.toml" ] && rg -q '^\[tool\.mutmut\]' pyproject.toml ) || \
             ( [ -f "setup.cfg" ] && rg -q '^\[mutmut\]' setup.cfg ); then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "should_run=false" >> "$GITHUB_OUTPUT"
      - name: Skip Python mutmut (no config)
        if: steps.detect_python.outputs.should_run != 'true'
        run: echo "No mutmut config found; skipping Python mutation tests."
      - name: Setup Python
        if: steps.detect_python.outputs.should_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
      - name: Install mutmut
        if: steps.detect_python.outputs.should_run == 'true'
        run: python -m pip install --upgrade pip mutmut
      - name: Run mutmut
        if: steps.detect_python.outputs.should_run == 'true'
        run: mutmut run

  mutation-js:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Detect JS mutation gate
        id: detect_js
        run: |
          set -euo pipefail
          if [ -f "scripts/mutation-gate.mjs" ] && \
             [ -f "scripts/mutation-stryker.config.mjs" ] && \
             [ -f "package.json" ] && \
             rg -q '"test:mutation:gate"\s*:' package.json; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "should_run=false" >> "$GITHUB_OUTPUT"
      - name: Skip JS mutation gate (not configured)
        if: steps.detect_js.outputs.should_run != 'true'
        run: echo "No JS mutation gate found; skipping JS mutation tests."
      - name: Setup Node
        if: steps.detect_js.outputs.should_run == 'true'
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Install dependencies
        if: steps.detect_js.outputs.should_run == 'true'
        run: npm ci
      - name: Run JS mutation gate (full critical scope)
        if: steps.detect_js.outputs.should_run == 'true'
        run: npm run test:mutation:gate
      - name: Upload mutation latest report
        if: always() && steps.detect_js.outputs.should_run == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: mutation-gate-latest-weekly
          path: .runtime-cache/test_output/mutation-gate/latest.json
          if-no-files-found: warn

  mutation-rust:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Detect Cargo manifest
        id: detect_rust
        run: |
          set -euo pipefail
          if [ -f "src-tauri/Cargo.toml" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "should_run=false" >> "$GITHUB_OUTPUT"
      - name: Skip cargo-mutants (no Cargo.toml)
        if: steps.detect_rust.outputs.should_run != 'true'
        run: echo "No src-tauri/Cargo.toml found; skipping Rust mutation tests."
      - name: Setup Rust
        if: steps.detect_rust.outputs.should_run == 'true'
        uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable
      - name: Cache Rust build
        if: steps.detect_rust.outputs.should_run == 'true'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-cargo-mutants-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-mutants-
      - name: Install cargo-mutants
        if: steps.detect_rust.outputs.should_run == 'true'
        run: cargo install cargo-mutants --locked
      - name: Run cargo-mutants
        if: steps.detect_rust.outputs.should_run == 'true'
        run: cargo mutants --manifest-path src-tauri/Cargo.toml
