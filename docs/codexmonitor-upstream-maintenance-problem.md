# CodexMonitor ä¸Šæ¸¸åŒæ­¥ä¸é­”æ”¹ç»´æŠ¤é—®é¢˜å®šä¹‰ï¼ˆCanonicalï¼‰

## ğŸ¯ æ–‡æ¡£ç›®æ ‡
- å®šä¹‰ CodexMonitor å½“å‰â€œä¸Šæ¸¸æŒç»­æ›´æ–° + æœ¬åœ°æ·±åº¦é­”æ”¹â€å¯¼è‡´çš„çœŸå®ç»´æŠ¤é—®é¢˜ã€‚
- ä»¥ä»“åº“è¯æ®ç»™å‡ºé—®é¢˜åˆ†çº§ä¸å¯æ‰§è¡Œçš„æ²»ç†åŸºçº¿ï¼Œä½œä¸ºåç»­å®æ–½çš„å•ä¸€çœŸç›¸æºï¼ˆSSOTï¼‰ã€‚

---

## ğŸ“Œ ç°çŠ¶å¿«ç…§ï¼ˆåŸºäºä»“åº“äº‹å®ï¼‰

æ—¶é—´åŸºçº¿ï¼š2026-02-17

1. åˆ†å‰çŠ¶æ€
- å½“å‰åˆ†æ”¯ï¼š`main`
- ä¸è¿œç«¯å…³ç³»ï¼š`ahead 24, behind 9`
- è¯´æ˜ï¼šæœ¬åœ°å†å²ä¸è¿œç«¯å†å²å·²äº¤ç»‡ï¼Œå­˜åœ¨é•¿æœŸå†²çªæ”¾å¤§é£é™©ã€‚

2. å¼•å…¥æ–¹å¼
- ä»“åº“æ—  `.gitmodules`ï¼Œä¸æ˜¯ `submodule` ç»´æŠ¤æ¨¡å¼ã€‚
- ä»“åº“æ— å¯è¯†åˆ« `subtree` æäº¤è½¨è¿¹ï¼Œä¸æ˜¯æ ‡å‡† `subtree` ç»´æŠ¤æ¨¡å¼ã€‚
- `ç¬¬ä¸‰æ–¹Repoå‚è€ƒ/` å·²è¢« `.gitignore` å¿½ç•¥ä¸”æœªè¢« Git è·Ÿè¸ªï¼ˆ`git ls-files` ä¸º 0ï¼‰ã€‚
- è¯´æ˜ï¼šå½“å‰ç»´æŠ¤å¯¹è±¡æ˜¯ **CodexMonitor ä¸»ä»“æœ¬ä½“**ï¼Œä¸æ˜¯å†…åµŒç¬¬ä¸‰æ–¹å­ä»“ã€‚

3. å˜æ›´è§„æ¨¡ï¼ˆ`origin/main..main`ï¼‰
- `647 files changed, 69831 insertions(+), 32674 deletions(-)`
- æ¶‰åŠå‰ç«¯ã€Rust åç«¯ã€æ–‡æ¡£ã€æµ‹è¯•ã€å®¡è®¡äº§ç‰©ç­‰å¤šå±‚å¹¶å‘å˜æ›´ã€‚
- è¯´æ˜ï¼šè¿™æ˜¯â€œäº§å“çº§åˆ†å‰â€ï¼Œä¸æ˜¯å•ç‚¹ patchï¼Œä¸èƒ½ç»§ç»­é ä¸´æ—¶ merge/å†²çªæ‰‹ä¿®ç»´æŒã€‚

---

## ğŸ”¥ é—®é¢˜å®šä¹‰ï¼ˆProblem Statementï¼‰

### P0ï¼šä¸»çº¿æ¼”è¿›æ¨¡å‹ç¼ºå¤±
- å½“å‰ `main` åŒæ—¶æ‰¿æ‹…äº†â€œè·Ÿä¸Šæ¸¸â€ä¸â€œæ‰¿è½½æœ¬åœ°é­”æ”¹â€ä¸¤ç§èŒè´£ã€‚
- åæœï¼šæ¯æ¬¡åŒæ­¥ä¸Šæ¸¸æ—¶ï¼Œå†²çªèŒƒå›´ä¸å¯é¢„æµ‹ï¼Œå†å²å¯è§£é‡Šæ€§ä¸‹é™ã€‚

### P0ï¼šè¡¥ä¸ä¸å¯é‡æ”¾
- æœ¬åœ°æ”¹åŠ¨æœªè¢«ç¨³å®šç»´æŠ¤ä¸ºå¯é‡æ”¾è¡¥ä¸åºåˆ—ï¼ˆpatch stackï¼‰ã€‚
- åæœï¼šå‡çº§è·¯å¾„ä¾èµ–â€œä¸´åœºå†²çªå¤„ç†â€ï¼Œæ— æ³•å½¢æˆå¯å¤ç”¨ã€å¯å®¡è®¡çš„å‡çº§æµæ°´çº¿ã€‚

### P1ï¼šå†²çªå¤ç”¨æœºåˆ¶æœªåˆ¶åº¦åŒ–
- æœªå½¢æˆ `rerere + range-diff + worktree` çš„æ ‡å‡†åŒæ­¥æµç¨‹ã€‚
- åæœï¼šåŒç±»å†²çªé‡å¤æ”¯ä»˜æˆæœ¬ï¼Œä¸”ç¼ºä¹â€œè¡¥ä¸æ˜¯å¦è¢«æ”¹å½¢â€çš„ç³»ç»Ÿæ ¡éªŒã€‚

### P1ï¼šå˜æ›´è¾¹ç•Œä¸å™ªéŸ³éš”ç¦»ä¸è¶³
- å®¡è®¡äº§ç‰©ã€å®éªŒç›®å½•ã€å¤§ä½“é‡éæ ¸å¿ƒå˜æ›´ä¸æ ¸å¿ƒä¸šåŠ¡é€»è¾‘åœ¨åŒä¸€æ¼”è¿›æµé‡Œç«äº‰ã€‚
- åæœï¼šåŒæ­¥æ—¶å™ªéŸ³ä¸Šå‡ï¼Œä»£ç è¯„å®¡ä¸å›å½’éªŒè¯å‹åŠ›è¢«æ”¾å¤§ã€‚

---

## âœ… ç›®æ ‡çŠ¶æ€ï¼ˆTarget Stateï¼‰

1. ä¸Šæ¸¸ä¸é­”æ”¹åˆ†ç¦»
- `vendor/upstream`ï¼šåªé•œåƒä¸Šæ¸¸ï¼Œç¦æ­¢ä¸šåŠ¡æ”¹åŠ¨ã€‚
- `custom/main`ï¼šåªæ‰¿è½½æœ¬åœ°ä¸šåŠ¡è¡¥ä¸ï¼ŒæŒ‰ä¸»é¢˜å°æ­¥æäº¤ã€‚

2. åŒæ­¥æµç¨‹å¯é‡å¤
- å›ºå®š SOPï¼š`fetch upstream -> rebase patch stack -> range-diff -> test gate`
- åŒç±»å†²çªè‡ªåŠ¨å¤ç”¨ï¼ˆ`rerere`ï¼‰ã€‚

3. å‡çº§å¯éªŒè¯
- æ¯æ¬¡åŒæ­¥äº§å‡ºâ€œå†²çªæ¸…å• + å˜æ›´å·®å¼‚ + å›å½’ç»“æœâ€ä¸‰ä»¶å¥—è¯æ®ã€‚

---

## ğŸ§­ æ¨èæ²»ç†åŸºçº¿ï¼ˆé’ˆå¯¹ CodexMonitorï¼‰

### 1) è¿œç«¯ä¸åˆ†æ”¯æ¨¡å‹
- æ¨èåŒè¿œç«¯ï¼š
  - `upstream`ï¼šå®˜æ–¹ CodexMonitor ä»“åº“ï¼ˆåªè¯»è·Ÿè¸ªï¼‰
  - `origin`ï¼šä½ çš„ forkï¼ˆæ‰¿è½½å¯æ¨é€åˆ†æ”¯ï¼‰
- æ¨èåˆ†æ”¯ï¼š
  - `vendor/upstream`ï¼ˆè·Ÿè¸ª `upstream/main`ï¼‰
  - `custom/main`ï¼ˆä½ çš„äº§å“åˆ†æ”¯ï¼‰
  - `topic/*`ï¼ˆçŸ­ç”Ÿå‘½å‘¨æœŸåŠŸèƒ½åˆ†æ”¯ï¼‰

å¦‚æœæš‚æ—¶æ²¡æœ‰ä¸ªäºº forkï¼Œä¹Ÿå¯å…ˆå•è¿œç«¯æ‰§è¡ŒåŒæ ·åˆ†æ”¯ç­–ç•¥ï¼Œä½†é•¿æœŸå»ºè®®è¡¥é½åŒè¿œç«¯ã€‚

### 2) æ—¥å¸¸åŒæ­¥ SOPï¼ˆå¿…é¡»å›ºå®šåŒ–ï¼‰
1. æ›´æ–°ä¸Šæ¸¸åº•åº§ï¼š
   - `git fetch upstream`
   - `git switch vendor/upstream`
   - `git reset --hard upstream/main`
2. é‡æ”¾æœ¬åœ°è¡¥ä¸ï¼š
   - `git switch custom/main`
   - `git rebase vendor/upstream`
3. æ ¡éªŒè¡¥ä¸å½¢æ€ï¼š
   - `git range-diff upstream/main...custom/main <ä¸Šä¸€æ¬¡åŸºçº¿>...<æœ¬æ¬¡ç»“æœ>`
4. å›å½’é—¨ç¦ï¼š
   - `npm run lint`
   - `npm run typecheck`
   - `npm run test`
   - Rust å˜æ›´æ—¶ï¼š`(cd src-tauri && cargo check)`

### 3) å†²çªæˆæœ¬æ²»ç†
- å…¨å±€å¼€å¯ï¼š`git config --global rerere.enabled true`
- å›ºå®šä½¿ç”¨ `git worktree` åŒå·¥ä½œåŒºå¹¶è¡Œå¤„ç†ï¼š
  - ä¸€ä¸ªç›®å½•çœ‹ `vendor/upstream`
  - ä¸€ä¸ªç›®å½•ä¿® `custom/main`

### 4) å˜æ›´å«ç”Ÿ
- å®¡è®¡ä¸å®éªŒç›®å½•å˜æ›´éœ€ä¸æ ¸å¿ƒåŠŸèƒ½å˜æ›´åˆ†ç¦»ï¼ˆé¿å…å•æ¬¡åŒæ­¥è·¨åŸŸçˆ†ç‚¸ï¼‰ã€‚
- ç”Ÿæˆç‰©ä¸ç¼“å­˜åªç•™åœ¨ `.runtime-cache/`ï¼Œç¦æ­¢æ±¡æŸ“ä¸»çº¿æäº¤ã€‚

---

## ğŸ“Š æ‰§è¡ŒéªŒæ”¶æ ‡å‡†ï¼ˆDoDï¼‰

- ä»»æ„ä¸€æ¬¡ä¸Šæ¸¸åŒæ­¥åï¼Œ`custom/main` å¯ä»¥åœ¨ 1 æ¬¡æ ‡å‡†æµç¨‹å†…å®Œæˆé‡æ”¾ã€‚
- `range-diff` å¯æ˜ç¡®è¯´æ˜æœ¬åœ°è¡¥ä¸åºåˆ—æœªå‡ºç°éé¢„æœŸæ”¹å½¢ã€‚
- åŒæ­¥åè´¨é‡é—¨ç¦å…¨ç»¿ï¼ˆlint/typecheck/test + å¿…è¦ cargo checkï¼‰ã€‚
- æœ‰å¯è¿½æº¯è®°å½•ï¼šåŒæ­¥æ—¥æœŸã€ä¸Šæ¸¸åŸºçº¿ commitã€æœ¬åœ°è¡¥ä¸æ•°é‡ã€å†²çªæ•°é‡ã€å›å½’ç»“æœã€‚

---

## âš ï¸ å½“å‰é˜¶æ®µç»“è®º

CodexMonitor å½“å‰å±äºâ€œå·²å½¢æˆäº§å“çº§åˆ†å‰ä½†å°šæœªåˆ¶åº¦åŒ–åŒæ­¥â€çš„é˜¶æ®µã€‚  
ç»§ç»­åœ¨å•ä¸€ `main` ä¸Šæ··åˆåŒæ­¥ä¸é­”æ”¹ï¼Œä¼šä½¿å‡çº§æˆæœ¬éšæ—¶é—´éçº¿æ€§ä¸Šå‡ã€‚  
æœ€ä¼˜è·¯å¾„ä¸æ˜¯å†æ‰¾ä¸€æ¬¡æ€§çš„å†²çªæŠ€å·§ï¼Œè€Œæ˜¯æŠŠåŒæ­¥æµç¨‹äº§å“åŒ–ï¼š**ä¸Šæ¸¸åº•åº§ + å¯é‡æ”¾è¡¥ä¸æ ˆ + å›ºåŒ–éªŒè¯é—¸é—¨**ã€‚

---

## ğŸš€ å·²æ‰§è¡Œè½åœ°ï¼ˆ2026-02-17ï¼‰

å·²åœ¨ä»“åº“ä¸­å®Œæˆä»¥ä¸‹æ‰§è¡Œé¡¹ï¼š

1. æ–°å¢åŒæ­¥è„šæœ¬
- `scripts/sync-upstream.sh`
- `scripts/sync-verify.sh`

2. æ–°å¢ npm å‘½ä»¤
- `npm run sync:upstream`
- `npm run sync:upstream:dry`
- `npm run sync:verify`
- `npm run sync:verify:fast`

3. ä»“åº“ç»´æŠ¤éª¨æ¶åˆå§‹åŒ–
- å·²å¯ç”¨æœ¬ä»“ `rerere.enabled=true`
- å·²åˆ›å»ºåˆ†æ”¯ï¼š
  - `vendor/upstream`ï¼ˆè·Ÿè¸ª `origin/main`ï¼‰
  - `custom/main`ï¼ˆä»å½“å‰ `main` å»ºç«‹ï¼‰

4. å·²æ‰§è¡ŒéªŒè¯
- dry-runï¼š`bash scripts/sync-upstream.sh --dry-run --allow-dirty --upstream-remote origin --upstream-branch main --custom-branch main --vendor-branch vendor/upstream`
- fast verifyï¼š`npm run -s sync:verify:fast -- --upstream-remote origin --upstream-branch main --custom-branch custom/main`
- è¾“å‡ºåŸºçº¿ï¼š`behind=9, ahead=24`ï¼Œå˜æ›´è§„æ¨¡ `647 files`
